<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
        <title>AJ Framework-API åŠ å¯†/è§£å¯†</title>
        <meta
            name="description"
            content="AJ Framework ä¸€ä¸ªåŸºäº SpringMVC æ„å»ºçš„è½»é‡çº§æ¡†æ¶ï¼Œæ—¨åœ¨å¢å¼º SpringMVC å¹¶ä½¿å…¶æ›´å…· SpringBoot çš„ç‰¹æ€§ã€‚å®ƒæ‹¥æœ‰è®¸å¤šå°å‹ç»„ä»¶ï¼Œéå¸¸æ˜“äºä½¿ç”¨ã€‚"/>
        <meta name="keywords" content="AJ Framework, ajaxjs, ajaxjs framework, java framework, web framewwork"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap&family=Noto+Sans+SC:wght@100..900&display=swap" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap" /> 
        <link rel="stylesheet" href="/style/docs/main.css"/>
        <link rel="icon" type="image/x-icon" href="/asset/aj-docs/logo.ico"/>
        <script src="/asset/docs/js/common.js"></script>
    </head>
    <body>
        <nav>
            <div>
                <div class="links">
                    <a href="/">ğŸ  Home</a>
                    |
                                    âš™ï¸ Source:
                    <a target="_blank" href="https://github.com/lightweight-component/SqlMan">Github</a>/<a target="_blank" href="https://gitcode.com/lightweight-component/SqlMan/overview">Gitcode</a>
                    |
                    <a href="/docs/common/contact">âœ‰ï¸ Contact</a>
                </div>
                <h1>
                    <img src="/asset/aj-docs/logo.png" style="vertical-align: middle;height: 45px;margin-bottom: 6px;" /> 
                    AJ Framework
                </h1>
                <h3>è½»é‡çº§ Java å¿«é€Ÿå¼€å‘æ¡†æ¶
                </h3>
            </div>
        </nav>
        <div>
            <menu>
                
                <ul>
                    <li class="selected">
                        <a href="/aj-docs">é¦–é¡µ</a>
                    </li>
                    <li>
                        <a href="/aj-docs/quick-start">å¿«é€Ÿå¼€å§‹</a>
                    </li>
                </ul>
                <h3>å¼€å§‹</h3>
                <ul>
                    <li>
                        <a href="pages/api/init.html">åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®</a>
                    </li>
                    <li>
                        <a href="/aj-docs/init/controller">ç®€åŒ–æ§åˆ¶å™¨ä¸ºæ¥å£</a>
                    </li>
                    <li>
                        <a href="/aj-docs/init/global">ç»Ÿä¸€è¿”å›ã€ç»Ÿä¸€å¼‚å¸¸</a>
                    </li>
                    <li>
                        <a href="pages/api/package.html">æ‰“åŒ…ä¸éƒ¨ç½²</a>
                    </li>
                </ul>
                <h3>API åŠŸèƒ½</h3>
                <ul>
                    <li class="data">
                        <a href="/aj-docs/api/api-limit/">API é™æµ</a>
                    </li>
                    <li>
                        <a href="/aj-docs/api/api-encode/">API åŠ å¯†/è§£å¯†</a>
                    </li>
                    <li>
                        <a href="/aj-docs/api/api-security/">API å®‰å…¨</a>
                    </li>
                    <li>
                        <a href="/aj-docs/api/bean-validator/">Bean å®ä½“æ ¡éªŒ</a>
                    </li>
                </ul>
                <h3>å…¶ä»–æ¨¡å—</h3>
                <ul>
                    <li>
                        <a href="/aj-docs/misc/cache">ä½¿ç”¨å¤šçº§ç¼“å­˜</a>
                    </li>
                    <li>
                        <a href="/aj-docs/misc/desensitize">è„±æ•ç»„ä»¶</a>
                    </li>
                    <li>
                        <a href="/aj-docs/misc/trace">é“¾è·¯è·Ÿè¸ª</a>
                    </li>
                    <li>
                        <a href="/aj-docs/misc/dlock">åˆ†å¸ƒå¼é”ã€å»¶è¿Ÿæ¶ˆæ¯</a>
                    </li>
                </ul>
    
                <h3>Misc</h3>
                <ul>
                    <li><a href="/aj-docs/common/versions">Release History</a></li>
                    <li><a href="/aj-docs/common/contact">Contact</a></li>
                </ul>
            </menu>
            <article>
                <h1>API æ¥å£åŠ å¯†/è§£å¯†</h1>
<p>ä¸ºäº†å®‰å…¨æ€§éœ€è¦å¯¹æ¥å£çš„æ•°æ®è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œä¸èƒ½æ˜æ–‡æš´éœ²æ•°æ®ã€‚ä¸ºæ­¤åº”è¯¥å¯¹æ¥å£è¿›è¡ŒåŠ å¯†/è§£å¯†å¤„ç†ï¼Œå¯¹äºæ¥å£çš„è¡Œä¸ºï¼Œåˆ†åˆ«æœ‰ï¼š</p>
<ul>
<li>å…¥å‚ï¼Œå¯¹ä¼ è¿‡æ¥çš„åŠ å¯†å‚æ•°è§£å¯†ã€‚æ¥å£å¤„ç†å®¢æˆ·ç«¯æäº¤çš„å‚æ•°æ—¶å€™ï¼Œè¿™é‡Œç»Ÿä¸€çº¦å®šå¯¹ HTTP Raw Body æäº¤çš„æ•°æ®ï¼ˆå·²åŠ å¯†çš„å¯†æ–‡ï¼‰ï¼Œè½¬æ¢ä¸º JSON å¤„ç†ï¼Œè¿™æ˜¯æœ€å¸¸è§çš„æäº¤æ–¹å¼ã€‚å…¶ä»– QueryStringã€æ ‡å‡† Formã€HTTP Header çš„å…¥å‚åˆ™ä¸æ”¯æŒã€‚</li>
<li>å‡ºå‚ï¼Œå¯¹è¿”å›å€¼è¿›è¡ŒåŠ å¯†ã€‚æ¥å£ç»Ÿä¸€è¿”å›åŠ å¯†åçš„ JSON ç»“æœã€‚</li>
</ul>
<p>æœ‰äººæŠŠåŠ å¯†ç»“æœåŸæ–‡è¾“å‡ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/asset/aj-docs/api-encode.png" alt="">
ä½†ç¬”è€…è§‰å¾—é‚£æ˜¯ä¸€ç§åæ¨¡å¼ï¼Œè€Œä¿ç•™åŸæœ‰ JSON ç»“æ„æ›´å¥½ï¼Œå¦‚ä¸‹æäº¤çš„ JSONã€‚</p>
<pre><code class="language-json">{
    &quot;errCode&quot;: &quot;0&quot;,
    &quot;data&quot;: &quot;BQduoGH4PI+6jxgu+6S2FWu5c/vHd+041ITnCH9JulUKpPX8BvRTvBNYfP7â€¦â€¦&quot;
}
</code></pre>
<p>å¦å¤–ä¹Ÿç¬¦åˆæ—¢æœ‰çš„ç»Ÿä¸€è¿”å›ç»“æœï¼Œå³æŠŠ<code>data</code>æ•°æ®åŠ å¯†ï¼Œå…¶ä»–<code>code</code>ã€<code>msg</code>ç­‰çš„æ­£å¸¸æ˜¾ç¤ºã€‚</p>
<p>ç³»ç»Ÿè¦æ±‚ï¼šåªæ”¯æŒ Spring + Jackson çš„æ–¹æ¡ˆã€‚</p>
<h2>åŠ å¯†ç®—æ³•</h2>
<p>åŠ å¯†ç®—æ³•éœ€è¦è°ƒç”¨æ–¹ï¼ˆå¦‚æµè§ˆå™¨ï¼‰ä¸ API æ¥å£åå•†å¥½ã€‚ä¸€èˆ¬é‡‡ç”¨ RSA åŠ å¯†ç®—æ³•ã€‚è™½ç„¶ RSA æ²¡ AES é€Ÿåº¦é«˜ï¼Œä½†èƒœåœ¨æ˜¯éå¯¹ç§°åŠ å¯†ï¼ŒAES è¿™ç§å¯¹ç§°åŠ å¯†æœºåˆ¶åœ¨è¿™åœºåˆå°±ä¸é€‚ç”¨äº†ï¼ˆå› ä¸ºæµè§ˆå™¨æ˜¯ä¸èƒ½æ”¾ç½®ä»»ä½•å¯†é’¥çš„ï¼Œâ€”â€”é™¤éæ”¾ç½®éå¯¹ç§°çš„å…¬é’¥ï¼‰ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœä½ è®¾è®¡çš„ API æ¥å£ç»™å…¶ä»–ç¬¬ä¸‰æ–¹è°ƒç”¨è€Œä¸æ˜¯æµè§ˆå™¨ï¼Œå¯ä»¥ä¿è¯å¯†é’¥å®‰å…¨çš„è¯ï¼Œé‚£ä¹ˆä½¿ç”¨ AES ä¹Ÿå¯ä»¥ï¼ŒåŒ…æ‹¬å…¶ä»–æ‘˜è¦ç®—æ³•åŒç†äº¦å¯ï¼Œå¤§å®¶å•†å®šå¥½ç®—æ³•ï¼ˆmd5/sha1/sha256â€¦â€¦ï¼‰å’Œç›å€¼ï¼ˆSlatï¼‰å³å¯ã€‚</p>
<p>è¯¥ç»„ä»¶å½“å‰ä»…æ”¯æŒ RSAï¼ˆ1024bit keyï¼‰ã€‚ä¸‹é¢æ›´å¤šçš„ç®—æ³•åœ¨è·¯ä¸Šã€‚</p>
<ul>
<li>RSAï¼ˆ512/2048â€¦â€¦ï¼‰</li>
<li>AES</li>
<li>MD5/SHA1/SHA256â€¦â€¦ with Slat</li>
</ul>
<h1>ä½¿ç”¨æ–¹å¼</h1>
<h2>åˆå§‹åŒ–</h2>
<p>åœ¨ YAML é…ç½®ä¸­åŠ å…¥ï¼š</p>
<pre><code class="language-yaml">api:
  EncryptedBody:
    enable: true
    publicKey: MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCmkKluNutOWGmAK2Uâ€¦â€¦
    privateKey: MIICdgIBADANBgkqhkiG9w0BAQâ€¦â€¦
</code></pre>
<p>ä¸»è¦æ˜¯ RSA çš„å…¬é’¥/ç§é’¥ã€‚ç„¶ååœ¨ Spring é…ç½®ç±»<code>WebMvcConfigurer</code>ä¸­åŠ å…¥ï¼š</p>
<pre><code class="language-java">@Value(&quot;${api.EncryptedBody.publicKey}&quot;)
private String apiPublicKey;

@Value(&quot;${api.EncryptedBody.privateKey}&quot;)
private String apiPrivateKey;

@Value(&quot;${api.EncryptedBody.enable}&quot;)
private boolean apiEncryptedBodyEnable;

@Override
public void configureMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {
    EncryptedBodyConverter converter = new EncryptedBodyConverter(apiPublicKey, apiPrivateKey);
    converter.setEnabled(apiEncryptedBodyEnable);

    converters.add(0, converter);
}
</code></pre>
<h2>é…ç½®è¦åŠ å¯†çš„æ•°æ®</h2>
<p>ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œå…¶å®å°±æ˜¯æ·»åŠ ä¸€ä¸ª Java æ³¨è§£<code>@EncryptedData</code>åˆ°ä½ çš„ Java Bean ä¸Šå³å¯ã€‚</p>
<p>ä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§æ­£å„¿å…«ç»çš„å¾ªåºæ¸è¿›çš„æ–¹å¼å»çœ‹çœ‹ã€‚é¦–å…ˆæ˜¯è§£å¯†è¯·æ±‚çš„æ•°æ®ï¼Œæˆ‘ä»¬è§‚å¯Ÿè¿™ä¸ª Spring MVC æ¥å£å£°æ˜ï¼Œä¸ä¸€èˆ¬çš„ JSON æäº¤æ•°æ®æ–¹å¼æ— å¼‚ï¼Œæ·»åŠ äº†æ³¨è§£<code>@RequestBody</code>ï¼Œå…¶ä»–æ— é¡»ä¿®æ”¹ï¼š</p>
<pre><code class="language-java">@PostMapping(&quot;/submit&quot;)
boolean jsonSubmit(@RequestBody User user);
</code></pre>
<p>é‡ç‚¹æ˜¯ User è¿™ä¸ª DTOï¼Œä¸ºäº†æ ‡æ˜æ˜¯åŠ å¯†æ•°æ®ï¼Œéœ€è¦åœ¨è¿™ä¸ª Bean ä¸Šå£°æ˜æˆ‘ä»¬è‡ªå®šä¹‰çš„æ³¨è§£<code>@EncryptedData</code>ï¼š</p>
<pre><code class="language-java">package com.ajaxjs.api.encryptedbody;

@EncryptedData
public class User {
    private String name;
    private int age;

    // Getters and Setters
}
</code></pre>
<p>åŒæ—¶æˆ‘ä»¬æäº¤çš„å¯¹è±¡ä¸å†æ˜¯ User çš„ JSONï¼Œè€Œæ˜¯<code>DecodeDTO</code>ï¼ˆè™½ç„¶æœ€ç»ˆè½¬æ¢ä¸º<code>User</code>ï¼ŒæˆåŠŸè§£å¯†çš„è¯ï¼‰ï¼Œå³:</p>
<pre><code class="language-java">package com.ajaxjs.api.encryptedbody;

import lombok.Data;

@Data
public class DecodeDTO {
    /**
     * Encrypted data
     */
    private String data;
}
</code></pre>
<p>å½“ç„¶ä½ å¯ä»¥ä¿®æ”¹è¿™ä¸ª DTO ä¸ºä½ ç¬¦åˆçš„ç»“æ„ã€‚æäº¤çš„æ ·å­å°±æ˜¯åƒ:</p>
<pre><code class="language-json">{
    &quot;data&quot;: &quot;BQduoGH4PI+6jxgu+6S2FWu5c/vHd+041ITnCH9JulUKpPX8BvRTvBNYfP7â€¦â€¦&quot;
}
</code></pre>
<p>è¿™ä¸ªåŠ å¯†è¿‡çš„å¯†æ–‡æ€ä¹ˆæ¥çš„ï¼Ÿå½“ç„¶æ˜¯ä½ å®¢æˆ·ç«¯åŠ å¯†åçš„ç»“æœã€‚æˆ–è€…ä»ä¸‹é¢å°èŠ‚è¯´çš„æ–¹å¼ï¼Œè¿”å›ä¸€æ®µå¯†æ–‡ã€‚</p>
<h2>è¿”å›åŠ å¯†çš„æ•°æ®</h2>
<p>ä¸‹é¢ Controller æ–¹æ³•è¿”å›ä¸€ä¸ª User å¯¹è±¡ï¼Œæ²¡æœ‰ä»»ä½•ä¿®æ”¹ã€‚</p>
<pre><code class="language-java">@GetMapping(&quot;/user&quot;)
User User();

â€¦â€¦

@Override
public User User() {
    User user = new User();
    user.setAge(1);
    user.setName(&quot;tom&quot;);
    
    return user;
}
</code></pre>
<p>æˆ‘ä»¬åŒæ ·éœ€è¦åŠ ä¸€ä¸ªæ³¨è§£<code>@EncryptedData</code>å³å¯å¯¹å…¶åŠ å¯†ã€‚å½“å‰ç‰ˆæœ¬ä¸­æš‚ä¸æ”¯æŒå­—æ®µçº§åˆ«çš„åŠ å¯†ï¼Œåªæ”¯æŒæ•´ä¸ªå¯¹è±¡åŠ å¯†ã€‚</p>
<p>è¿”å›ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-json">{
    &quot;status&quot;: 1,
    &quot;errorCode&quot;: null,
    &quot;message&quot;: &quot;æ“ä½œæˆåŠŸ&quot;,
    &quot;data&quot;: &quot;ReSSPC34JE+O/SmLCxE5zVJb6D2tzp1f5pfQyKdjvOWkQQ+qDjcjw/2m/KPA+2+uc9kseqFryXNPIZCEfsaOCJAqzMtrXyZ0JPB1skeJxKOngS5USijsY0UZqN9hLS3O/7CBLlSGkEuyXZV//WcWDG9BpQ4TAKrlRfwM4bnCo+E=&quot;
}
</code></pre>
<h2>æ·»åŠ ä¾èµ–</h2>
<p>å“¦~å¯¹äº†ï¼Œåˆ«å¿˜äº†æ·»åŠ ä¾èµ–ï¼Œâ€”â€”æ²¡å•ç‹¬æ jar åŒ…ï¼Œç›´æ¥ copy ä»£ç å§~æ‰ä¸‰ä¸ªç±»ï¼š<a href="https://gitcode.com/zhangxin09/aj-framework/tree/master/aj-framework/src/main/java/com/ajaxjs/api/encryptedbody">æºç </a>ã€‚</p>
<p>å…¶ä¸­<code>ResponseResultWrapper</code>å°±æ˜¯ç»Ÿä¸€è¿”å›ç»“æœçš„ç±»ï¼Œä½ å¯ä»¥æ”¹ä¸ºä½ é¡¹ç›®çš„ï¼Œâ€”â€”å…¶ä»–çš„æ²¡å•¥ä¾èµ–äº†ï¼Œâ€”â€”è¿˜æœ‰å°±æ˜¯ RSA ä¾èµ–æˆ‘çš„å·¥å…·åŒ…ï¼š</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;com.ajaxjs&lt;/groupId&gt;
    &lt;artifactId&gt;ajaxjs-util&lt;/artifactId&gt;
    &lt;version&gt;1.1.8&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>å¾ˆå°å·§çš„ï¼Œæ‰60kb çš„ jar åŒ…â€”â€”è¯·æ”¾å¿ƒé£Ÿç”¨~</p>
<h1>å®ç°æ–¹å¼</h1>
<p>è¿™é‡Œè¯´è¯´å®ç°åŸç†ï¼Œä»¥åŠä¸€äº› API è®¾è®¡é£æ ¼çš„æ€è€ƒã€‚</p>
<p>æˆ‘ä»¬è¿™ç§çš„ç”¨æ³•ï¼Œç›¸å½“äºæ¥æ”¶äº† A å¯¹è±¡ï¼ˆåŠ å¯†çš„ï¼Œ<code>DecodeDTO</code>ï¼‰ï¼Œè½¬æ¢ä¸º B å¯¹è±¡ï¼ˆè§£å¯†çš„ï¼Œä¾›æ§åˆ¶å™¨ä½¿ç”¨ï¼‰ã€‚æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-java">@PostMapping(&quot;/submit&quot;)
boolean jsonSubmit(@RequestBody DecodeDTO dto) {
    User user = è½¬æ¢å‡½æ•°(dto.getData());
}
</code></pre>
<p>ä½†æ˜¯è¿™ç§æ–¹æ³•ï¼Œæ–¹æ³•æ•°é‡ä¸€å¤šåˆ™éåœ°<code>DecodeDTO</code>ï¼ŒAPI æ–‡æ¡£ä¹Ÿæ²¡æ³•å†™äº†ï¼ˆç ´åäº†ä»£ç æ¸…æ™°åº¦ï¼Œä¸èƒ½åæ˜ åŸæ¥ä»£ç çš„æ„å›¾ï¼‰ã€‚ä¸ºæ­¤æˆ‘ä»¬åº”è¯¥å°½é‡é‡‡ç”¨â€œéå…¥ä¾µâ€çš„æ–¹æ³•ï¼Œæ‰€è°“éå…¥ä¾µï¼Œå°±æ˜¯ä¸ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œåªåšé¢å¤–çš„â€œè£…é¥°â€ã€‚è¿™ç§æ‰‹æ®µæœ‰å¾ˆå¤šï¼Œå…¸å‹å¦‚ AOPï¼Œå…¶ä»–åŒç±»çš„å¼€æºåº“ <a href="https://github.com/ishuibo/rsa-encrypt-body-spring-boot">rsa-encrypt-body-spring-boot</a>ã€<a href="https://github.com/Licoy/encrypt-body-spring-boot-starter">encrypt-body-spring-boot-starter</a> ä¹Ÿæ˜¯ä¸çº¦è€ŒåŒåœ°ä½¿ç”¨ AOPã€‚</p>
<p>ç„¶è€Œç¬”è€…ä¸ªäººæ¥è¯´ä¸å¤ªå–œæ¬¢ AOPï¼Œå¯èƒ½ä¹Ÿæ˜¯ä¸å¤Ÿç†Ÿæ‚‰å§â€”â€”åæ­£èƒ½ä¸ç”¨åˆ™ä¸ç”¨ã€‚å¦‚æœä¸ç”¨ AOP é‚£åº”è¯¥å¦‚ä½•åšå‘¢ï¼Ÿç¬”è€…æ€è€ƒäº†å‡ ç§æ–¹å¼ä¾‹å¦‚ Filterã€æ‹¦æˆªå™¨ç­‰ï¼Œä½†æœ€ç»ˆæŠŠè¿™ä¸ªé—®é¢˜å®šä½äº JSON åºåˆ—åŒ–/ååºåˆ—åŒ–å±‚é¢ä¸Šï¼Œåœ¨æ‰§è¡Œè¿™ä¸€æ­¥éª¤ä¹‹å‰å°±å¯ä»¥åšåŠ å¯†/è§£å¯†æ“ä½œäº†ã€‚å¼€å§‹ä»¥ä¸ºå¯ä»¥ä¿®æ”¹ Jackson å…¨å±€åºåˆ—åŒ–æ–¹å¼ï¼Œä½†ç¢äºå…¨å±€çš„è¯æ„Ÿè§‰ä¸å¤ªåˆç†ï¼Œæ›´åˆé€‚çš„æ˜¯åœ¨ä»‹ä¹äº Spring ä¸ Jackson ç»“åˆçš„åœ°æ–¹åšä¿®æ”¹ã€‚äºæ˜¯æœ‰äº†åœ¨çš„<code>MappingJackson2HttpMessageConverter</code>åŸºç¡€ä¸Šæ‰©å±•çš„ <code>EncryptedBodyConverter</code>ï¼Œé‡å†™äº†<code>read</code>æ–¹æ³•ï¼Œåœ¨ååºåˆ—åŒ–ä¹‹å‰å…ˆåšè§£å¯†æ“ä½œï¼Œ<code>writeInternal</code>æ–¹æ³•äº¦ç„¶ã€‚</p>
<p>æ ¸å¿ƒæ–¹æ³•å°±ä¸€ä¸ªç±»ï¼Œä¸è¶³ä¸€ç™¾è¡Œä»£ç ï¼š</p>
<pre><code class="language-java">import com.ajaxjs.springboot.ResponseResultWrapper;
import com.ajaxjs.util.EncodeTools;
import com.ajaxjs.util.cryptography.RsaCrypto;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.http.HttpInputMessage;
import org.springframework.http.HttpOutputMessage;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.http.converter.HttpMessageNotWritableException;
import org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;

import java.io.IOException;
import java.lang.reflect.Type;

public class EncryptedBodyConverter extends MappingJackson2HttpMessageConverter {
    public EncryptedBodyConverter(String publicKey, String privateKey) {
        super();
        this.publicKey = publicKey;
        this.privateKey = privateKey;
    }

    private final String publicKey;

    private final String privateKey;

    /**
     * ä½¿ç”¨ç§é’¥è§£å¯†å­—ç¬¦ä¸²
     *
     * @param encryptBody ç»è¿‡ Base64 ç¼–ç çš„åŠ å¯†å­—ç¬¦ä¸²
     * @param privateKey  ç§é’¥å­—ç¬¦ä¸²ï¼Œç”¨äºè§£å¯†
     * @return è§£å¯†åçš„å­—ç¬¦ä¸²
     */
    static String decrypt(String encryptBody, String privateKey) {
        byte[] data = EncodeTools.base64Decode(encryptBody);

        return new String(RsaCrypto.decryptByPrivateKey(data, privateKey));
    }

    /**
     * ä½¿ç”¨å…¬é’¥åŠ å¯†å­—ç¬¦ä¸²
     * &lt;p&gt;
     * è¯¥æ–¹æ³•é‡‡ç”¨RSAåŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨ç»™å®šçš„å…¬é’¥å¯¹ä¸€æ®µå­—ç¬¦ä¸²è¿›è¡ŒåŠ å¯†
     * åŠ å¯†åçš„å­—èŠ‚æ•°ç»„è¢«è½¬æ¢ä¸º Base64 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œä»¥ä¾¿äºä¼ è¾“å’Œå­˜å‚¨
     *
     * @param body      éœ€è¦åŠ å¯†çš„åŸå§‹å­—ç¬¦ä¸²
     * @param publicKey ç”¨äºåŠ å¯†çš„å…¬é’¥å­—ç¬¦ä¸²
     * @return åŠ å¯†åçš„ Base64 ç¼–ç å­—ç¬¦ä¸²
     */
    static String encrypt(String body, String publicKey) {
        byte[] encWord = RsaCrypto.encryptByPublicKey(body.getBytes(), publicKey);
        return EncodeTools.base64EncodeToString(encWord);
    }

    /**
     * é‡å†™ read æ–¹æ³•ä»¥æ”¯æŒåŠ å¯†æ•°æ®çš„è¯»å–
     *
     * @param type         æ•°æ®ç±»å‹ï¼Œç”¨äºç¡®å®šè¿”å›å¯¹è±¡çš„ç±»å‹
     * @param contextClass ä¸Šä¸‹æ–‡ç±»ï¼Œæœªåœ¨æœ¬æ–¹æ³•ä¸­ä½¿ç”¨
     * @param inputMessage åŒ…å«åŠ å¯†æ•°æ®çš„ HTTP è¾“å…¥æ¶ˆæ¯
     * @return æ ¹æ®ç±»å‹å‚æ•°ååºåˆ—åŒ–åçš„å¯¹è±¡å®ä¾‹
     * @throws IOException                     å¦‚æœè¯»å–æˆ–è§£æè¿‡ç¨‹ä¸­å‘ç”Ÿ I/O é”™è¯¯
     * @throws HttpMessageNotReadableException å¦‚æœæ¶ˆæ¯æ— æ³•è§£æä¸ºå¯¹è±¡å®ä¾‹
     */
    @Override
    public Object read(Type type, Class&lt;?&gt; contextClass, HttpInputMessage inputMessage) throws IOException, HttpMessageNotReadableException {
        Class&lt;?&gt; clz = (Class&lt;?&gt;) type;

        if (clz.getAnnotation(EncryptedData.class) != null) {
            ObjectMapper objectMapper = getObjectMapper();
            DecodeDTO decodeDTO = objectMapper.readValue(inputMessage.getBody(), DecodeDTO.class);
            String encryptBody = decodeDTO.getData();

            String decodeJson = decrypt(encryptBody, privateKey);

            return objectMapper.readValue(decodeJson, clz);
        }

        return super.read(type, contextClass, inputMessage);
    }

    @Override
    protected void writeInternal(Object object, Type type, HttpOutputMessage outputMessage) throws IOException, HttpMessageNotWritableException {
        Class&lt;?&gt; clz = (Class&lt;?&gt;) type;

        if (object instanceof ResponseResultWrapper &amp;&amp; clz.getAnnotation(EncryptedData.class) != null) {
            ResponseResultWrapper response = (ResponseResultWrapper) object;
            Object data = response.getData();
            String json = getObjectMapper().writeValueAsString(data);
            String encryptBody = encrypt(json, publicKey);

            response.setData(encryptBody);
        }

        super.writeInternal(object, type, outputMessage);
    }
}
</code></pre>
<p>TODO</p>
<ul>
<li>å¢åŠ åŠ å¯†è§£å¯†ç®—æ³•</li>
<li>å¢åŠ ä¸€ä¸ªåŠ å¯†é€‰é¡¹ï¼Œè¯´æ˜ä½¿ç”¨å…¬é’¥è¿˜æ˜¯ç§é’¥ã€‚å½“å‰æ˜¯å…¬é’¥</li>
<li>é’ˆå¯¹å­—æ®µå•ç‹¬çš„è§£å¯†</li>
</ul>
<p>å“ˆå“ˆ æœ€åå‘ç°ä¹Ÿæœ‰äººç”¨<code>HttpMessageConverter</code>æ¥åšï¼šhttps://blog.allbs.cn/posts/49043/ã€‚</p>

            </article>
        </div>

        <footer>
    SqlMan, a part of <a href="https://framework.ajaxjs.com" target="_blank">AJ-Framework</a> open source. Mail:
    frank@ajaxjs.com, visit <a href="https://blog.csdn.net/zhangxin09" target="_blank">my blog(In Chinese)</a>.
    <br />
    <br />
     Copyright Â© 2025 Frank Cheung. All rights reserved.
</footer>
    </body>
</html>